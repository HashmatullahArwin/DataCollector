<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Harvest â€” Client Entry</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --bg: #f4f6f9;
  --card: #fff;
  --accent: #2980b9;
  --good: #27ae60;
  --warn: #e67e22;
  --danger: #e74c3c;
}
body {
  font-family: Arial, Helvetica, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 20px;
  color: #222;
}
header { max-width: 1100px; margin: 0 auto 16px; }
.container {
  max-width: 1100px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 18px;
}
form, .dataCard {
  background: var(--card);
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, .06);
}
label { display: block; font-weight: 600; margin-top: 10px; }
input, select {
  width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-top: 6px;
}
button { padding: 10px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; }
.save { background: var(--good); color: #fff; }
.reset { background: var(--warn); color: #fff; }
.view { background: var(--accent); color: #fff; width: 100%; margin-top: 12px; }
.danger { background: var(--danger); color: #fff; }
.accent { background: var(--accent); color: #fff; }
table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.95rem; }
th, td { border: 1px solid #e6e6e6; padding: 8px; text-align: left; }
th { background: #2c3e50; color: #fff; }
.actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
@media (max-width:980px){ .container{grid-template-columns:1fr;} }
</style>
</head>

<body>
<header>
  <img src="E6AF6E5C-4098-4C8A-820B-F5BBBB9C27AE.PNG" alt="" style="width: 150px; height: 150px;"> 
</header>

<div class="container">
  <!-- Left: Client Form -->
  <form id="clientForm" autocomplete="off">
    <label>Staff Name</label>
    <input id="staffName" type="text" required placeholder="Staff who is entering data">

    <label>Case ID</label>
    <input id="caseId" type="text" required>

    <label>First Name</label>
    <input id="firstName" type="text" required>

    <label>Last Name</label>
    <input id="lastName" type="text" required>

    <label>Family Size</label>
    <input id="familySize" type="number" min="1" required>

    <label>Address</label>
    <input id="address" type="text" required>

    <label>Phone</label>
    <input id="phone" type="tel" required>

    <div class="actions">
      <button type="submit" class="save">Save</button>
      <button type="reset" class="reset">Reset</button>
    </div>
  </form>

  <!-- Right: View / Session / Data -->
  <div class="dataCard">
    <h3>Session Manager</h3>
    <select id="sessionSelect"></select>
    <div class="actions">
      <button id="newSession" class="accent">+ New Session</button>
      <button id="deleteSession" class="danger">Delete Session</button>
    </div>

    <button class="view" id="viewBtn">View Collected Data</button>

    <div id="dataSection" style="display:none;margin-top:10px">
      <h3>Collected Client Data</h3>
      <div style="overflow:auto;max-height:360px">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Case ID</th>
              <th>First</th>
              <th>Last</th>
              <th>Family</th>
              <th>Address</th>
              <th>Phone</th>
              <th>Time</th>
              <th>Staff</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="actions">
        <button onclick="printData()" class="save">Print</button>
        <button onclick="downloadCSV()" class="accent">Download CSV</button>
        <button onclick="downloadPDF()" class="accent">Download PDF</button>
        <button onclick="clearAllData()" class="danger">Clear All Session Data</button>
      </div>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = "sessions";
let currentSession = null;

// --- Setup ---
document.addEventListener("DOMContentLoaded", () => {
  loadSessions();
  document.getElementById("clientForm").addEventListener("submit", saveClient);
  document.getElementById("viewBtn").addEventListener("click", showData);
  document.getElementById("newSession").addEventListener("click", newSession);
  document.getElementById("deleteSession").addEventListener("click", deleteSession);
  document.getElementById("sessionSelect").addEventListener("change", changeSession);
});

// --- Session Management ---
function loadSessions() {
  const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  const select = document.getElementById("sessionSelect");
  select.innerHTML = "";

  Object.keys(sessions).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });

  if (!Object.keys(sessions).length) {
    newSession();
  } else {
    currentSession = select.value = currentSession || Object.keys(sessions)[0];
  }
}

function newSession() {
  const name = prompt("Enter a name for the new session:");
  if (!name) return;
  const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  if (sessions[name]) return alert("Session already exists!");
  sessions[name] = [];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
  currentSession = name;
  loadSessions();
  alert(`Session "${name}" created.`);
}

function deleteSession() {
  if (!currentSession) return;
  if (!confirm(`Delete session "${currentSession}"? This cannot be undone.`)) return;
  const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  delete sessions[currentSession];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
  currentSession = null;
  loadSessions();
  document.getElementById("dataSection").style.display = "none";
}

function changeSession() {
  currentSession = document.getElementById("sessionSelect").value;
  showData();
}

// --- Client Data ---
function saveClient(e) {
  e.preventDefault();
  if (!currentSession) return alert("Please select or create a session first.");

  const entry = {
    caseId: caseId.value.trim(),
    firstName: firstName.value.trim(),
    lastName: lastName.value.trim(),
    familySize: familySize.value,
    address: address.value.trim(),
    phone: phone.value.trim(),
    staffName: staffName.value.trim(),
    time: new Date().toLocaleString()
  };

  const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  sessions[currentSession].push(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));

  clientForm.reset();
  showData();
  alert("Client saved successfully.");
}

function showData() {
  if (!currentSession) return alert("No active session!");
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}")[currentSession] || [];
  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML = "";

  arr.forEach((c, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(c.caseId)}</td>
      <td>${escapeHtml(c.firstName)}</td>
      <td>${escapeHtml(c.lastName)}</td>
      <td>${escapeHtml(c.familySize)}</td>
      <td>${escapeHtml(c.address)}</td>
      <td>${escapeHtml(c.phone)}</td>
      <td>${escapeHtml(c.time)}</td>
      <td>${escapeHtml(c.staffName)}</td>
      <td>
        <button class="accent" onclick="editClient(${i})">Edit</button>
        <button class="danger" onclick="deleteClient(${i})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("dataSection").style.display = "block";
}

function editClient(index) {
  const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  const arr = sessions[currentSession];
  const c = arr[index];
  caseId.value = c.caseId;
  firstName.value = c.firstName;
  lastName.value = c.lastName;
  familySize.value = c.familySize;
  address.value = c.address;
  phone.value = c.phone;
  staffName.value = c.staffName;
  deleteClient(index);
}

function deleteClient(index) {
  const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  sessions[currentSession].splice(index, 1);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
  showData();
}

function clearAllData() {
  if (!currentSession) return;
  if (!confirm("Delete all data in this session?")) return;
  const sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  sessions[currentSession] = [];
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
  showData();
}

// --- Export & Utility ---
function downloadCSV() {
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}")[currentSession] || [];
  if (!arr.length) return alert("No data to download.");
  const csv = [
    ["Case ID","First","Last","Family","Address","Phone","Time","Staff"],
    ...arr.map(c => [c.caseId,c.firstName,c.lastName,c.familySize,c.address,c.phone,c.time,c.staffName])
  ].map(r => r.map(v => `"${v}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${currentSession}-clients.csv`; a.click();
  URL.revokeObjectURL(url);
}

function downloadPDF() {
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}")[currentSession] || [];
  if (!arr.length) return alert("No data to include.");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`Client Data (${currentSession})`, 14, 16);
  doc.autoTable({
    startY: 20,
    head: [['Case ID','First','Last','Family','Address','Phone','Time','Staff']],
    body: arr.map(c => [c.caseId,c.firstName,c.lastName,c.familySize,c.address,c.phone,c.time,c.staffName])
  });
  doc.save(`${currentSession}-clients.pdf`);
}

function printData() { window.print(); }

function escapeHtml(text){
  return String(text||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
</script>
</body>
</html>
